<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Code Journey</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .admin-header {
      background: var(--surface);
      padding: 20px 40px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .admin-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .admin-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .user-info {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px;
    }
    
    .editor-card {
      background: var(--surface);
      padding: 40px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 40px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
    }
    
    .form-group textarea {
      min-height: 200px;
      font-family: inherit;
      resize: vertical;
    }
    
    #content {
      min-height: 400px;
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      line-height: 1.6;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .posts-list {
      background: var(--surface);
      padding: 40px;
      border-radius: 20px;
      box-shadow: var(--shadow);
    }
    
    .posts-list h2 {
      margin-bottom: 24px;
      color: var(--text-primary);
    }
    
    .post-item {
      padding: 20px;
      background: var(--surface-muted);
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .post-info h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .post-meta-info {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .post-actions {
      display: flex;
      gap: 8px;
    }
    
    .icon-button {
      background: transparent;
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .icon-button:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
    }
    
    .status-message {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
    }
    
    .status-message.show {
      display: block;
    }
    
    .status-message.success {
      background: #d4edda;
      color: #155724;
    }
    
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    @media (max-width: 900px) {
      .admin-container {
        padding: 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .post-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
    }
    
    @media (min-width: 901px) and (max-width: 1200px) {
      .form-row {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-title">üìù Admin Panel</div>
    <div class="admin-actions">
      <span class="user-info" id="userEmail"></span>
      <button class="secondary-button" onclick="window.location.href='index.html'">View Site</button>
      <button class="ghost-button" id="logoutButton">Logout</button>
    </div>
  </header>

  <div class="admin-container">
    <div class="editor-card">
      <h2 id="editorTitle">Write New Blog Post</h2>
      
      <div id="statusMessage" class="status-message"></div>
      
      <form id="postForm">
        <div class="form-row">
          <div class="form-group">
            <label for="title">Title *</label>
            <input type="text" id="title" required placeholder="Your post title...">
          </div>
          
          <div class="form-group">
            <label for="category">Category *</label>
            <select id="category" required>
              <option value="SwiftUI">SwiftUI</option>
              <option value="Performance">Performance</option>
              <option value="Architecture">Architecture</option>
              <option value="Swift">Swift</option>
              <option value="UIKit">UIKit</option>
              <option value="Testing">Testing</option>
              <option value="Tools">Tools</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="readTime">Read Time *</label>
            <input type="text" id="readTime" required placeholder="5 min read">
          </div>
          
          <div class="form-group">
            <label for="postDate">Post Date *</label>
            <input type="date" id="postDate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label for="excerpt">Excerpt *</label>
          <textarea id="excerpt" rows="3" required placeholder="Brief description of your post..."></textarea>
        </div>
        
        <div class="form-group">
          <label for="content">Full Content (HTML) *</label>
          <textarea id="content" required placeholder="<h2>Introduction</h2><p>Your content here...</p>"></textarea>
        </div>
        
        <div class="button-group">
          <button type="submit" class="primary-button" id="publishButton">Publish Post</button>
          <button type="button" class="secondary-button" id="cancelEditButton" style="display: none;">Cancel Edit</button>
          <button type="button" class="secondary-button" id="clearButton">Clear Form</button>
        </div>
      </form>
    </div>

    <div class="posts-list">
      <h2>Published Posts</h2>
      <div id="postsList">
        <p style="color: var(--text-secondary);">Loading posts...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, isAdmin } from './js/firebase-config.js';
    import { 
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { 
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      doc as firestoreDoc,
      updateDoc,
      serverTimestamp,
      orderBy,
      query
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Track if we're editing a post
    let editingPostId = null;

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('postDate').value = today;

    // Auth check - only allow admin access
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // Not logged in - redirect to login
        window.location.href = 'admin-login.html';
      } else if (!isAdmin(user)) {
        // Logged in but not admin - redirect to main page with alert
        alert('Access denied. Admin privileges required.');
        window.location.href = 'index.html';
      } else {
        // Logged in as admin - allow access
        document.getElementById('userEmail').textContent = user.email;
        loadPosts();
      }
    });

    // Logout
    document.getElementById('logoutButton').addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = 'admin-login.html';
      } catch (error) {
        console.error('Logout error:', error);
      }
    });

    // Publish or Update post
    const postForm = document.getElementById('postForm');
    const statusMessage = document.getElementById('statusMessage');
    const publishButton = document.getElementById('publishButton');
    const editorTitle = document.getElementById('editorTitle');
    const cancelEditButton = document.getElementById('cancelEditButton');

    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      publishButton.disabled = true;
      const originalText = publishButton.textContent;
      publishButton.textContent = editingPostId ? 'Updating...' : 'Publishing...';
      
      // Get the custom date
      const customDateInput = document.getElementById('postDate').value;
      const customDate = new Date(customDateInput);
      
      const postData = {
        title: document.getElementById('title').value,
        category: document.getElementById('category').value,
        readTime: document.getElementById('readTime').value,
        excerpt: document.getElementById('excerpt').value,
        content: document.getElementById('content').value,
        author: auth.currentUser.email,
        date: customDate.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        }),
        sortDate: customDate.getTime() // Store as timestamp for sorting
      };

      try {
        if (editingPostId) {
          // Update existing post
          postData.updatedAt = serverTimestamp();
          await updateDoc(firestoreDoc(db, 'posts', editingPostId), postData);
          
          statusMessage.className = 'status-message success show';
          statusMessage.textContent = `‚úÖ Post updated successfully!`;
          
          cancelEdit();
        } else {
          // Create new post
          postData.timestamp = serverTimestamp();
          
          const docRef = await addDoc(collection(db, 'posts'), postData);
          
          statusMessage.className = 'status-message success show';
          statusMessage.textContent = `‚úÖ Post published successfully! Document ID: ${docRef.id}`;
          
          postForm.reset();
        }
        
        loadPosts();
        
        setTimeout(() => {
          statusMessage.classList.remove('show');
        }, 5000);
        
      } catch (error) {
        console.error('Error saving post:', error);
        statusMessage.className = 'status-message error show';
        statusMessage.textContent = `‚ùå Error: ${error.message}`;
      } finally {
        publishButton.disabled = false;
        publishButton.textContent = originalText;
      }
    });

    // Edit post
    window.editPost = async (postId) => {
      try {
        const docRef = firestoreDoc(db, 'posts', postId);
        const docSnap = await getDocs(query(collection(db, 'posts')));
        
        let postData = null;
        docSnap.forEach((doc) => {
          if (doc.id === postId) {
            postData = doc.data();
          }
        });
        
        if (!postData) {
          alert('Post not found');
          return;
        }
        
        // Populate form
        document.getElementById('title').value = postData.title;
        document.getElementById('category').value = postData.category;
        document.getElementById('readTime').value = postData.readTime;
        document.getElementById('excerpt').value = postData.excerpt;
        document.getElementById('content').value = postData.content;
        
        // Convert date back to YYYY-MM-DD format for the date input
        if (postData.sortDate) {
          const date = new Date(postData.sortDate);
          const dateString = date.toISOString().split('T')[0];
          document.getElementById('postDate').value = dateString;
        } else if (postData.date) {
          // Fallback: try to parse the formatted date string
          const date = new Date(postData.date);
          const dateString = date.toISOString().split('T')[0];
          document.getElementById('postDate').value = dateString;
        }
        
        // Update UI
        editingPostId = postId;
        editorTitle.textContent = '‚úèÔ∏è Edit Blog Post';
        publishButton.textContent = 'Update Post';
        cancelEditButton.style.display = 'inline-block';
        
        // Scroll to form
        document.querySelector('.editor-card').scrollIntoView({ behavior: 'smooth' });
        
        statusMessage.className = 'status-message show';
        statusMessage.style.background = '#d1ecf1';
        statusMessage.style.color = '#0c5460';
        statusMessage.textContent = `üìù Editing post: ${postData.title}`;
        
      } catch (error) {
        console.error('Error loading post for editing:', error);
        alert('Error loading post: ' + error.message);
      }
    };
    
    // Cancel edit
    function cancelEdit() {
      editingPostId = null;
      editorTitle.textContent = 'Write New Blog Post';
      publishButton.textContent = 'Publish Post';
      cancelEditButton.style.display = 'none';
      postForm.reset();
      // Reset date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('postDate').value = today;
      statusMessage.classList.remove('show');
    }
    
    cancelEditButton.addEventListener('click', () => {
      if (confirm('Cancel editing? Any unsaved changes will be lost.')) {
        cancelEdit();
      }
    });

    // Clear form
    document.getElementById('clearButton').addEventListener('click', () => {
      if (confirm('Clear the form?')) {
        postForm.reset();
        // Reset date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('postDate').value = today;
      }
    });

    // Load posts
    async function loadPosts() {
      const postsList = document.getElementById('postsList');
      
      try {
        // Try to sort by sortDate, fallback to timestamp if sortDate doesn't exist
        const q = query(collection(db, 'posts'), orderBy('sortDate', 'desc'));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          postsList.innerHTML = '<p style="color: var(--text-secondary);">No posts yet. Create your first post above!</p>';
          return;
        }
        
        postsList.innerHTML = '';
        
        querySnapshot.forEach((docSnapshot) => {
          const post = docSnapshot.data();
          const postItem = document.createElement('div');
          postItem.className = 'post-item';
          postItem.innerHTML = `
            <div class="post-info">
              <h3>${post.title}</h3>
              <div class="post-meta-info">
                <span class="pill">${post.category}</span>
                <span class="read-time-badge">${post.readTime}</span>
                <span>${post.date}</span>
              </div>
            </div>
            <div class="post-actions">
              <button class="icon-button" onclick="editPost('${docSnapshot.id}')">‚úèÔ∏è Edit</button>
              <button class="icon-button" onclick="deletePost('${docSnapshot.id}', '${post.title}')">üóëÔ∏è Delete</button>
            </div>
          `;
          postsList.appendChild(postItem);
        });
        
      } catch (error) {
        console.error('Error loading posts:', error);
        postsList.innerHTML = `<p style="color: #c33;">Error loading posts: ${error.message}</p>`;
      }
    }

    // Delete post
    window.deletePost = async (postId, postTitle) => {
      if (!confirm(`Delete "${postTitle}"?`)) return;
      
      try {
        await deleteDoc(firestoreDoc(db, 'posts', postId));
        loadPosts();
        statusMessage.className = 'status-message success show';
        statusMessage.textContent = '‚úÖ Post deleted successfully!';
        setTimeout(() => statusMessage.classList.remove('show'), 3000);
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Error deleting post: ' + error.message);
      }
    };
  </script>
</body>
</html>
